# ESP32-S3 MacroPad configuration (source of truth)
# -----------------------------------------------------------------------------
# Every value in this file is converted into main/keymap_config.h at build time.
# Edit this YAML, then rebuild (or run the generator script directly).
#
# Generator:
#   python tools/generate_keymap_header.py --in config/keymap_config.yaml --out main/keymap_config.h

# File-format version for future migration logic.
schema_version: 1

# Global table sizes used by generated C arrays.
counts:
  # Number of physical keys in each layer map.
  key: 12
  # Number of logical layers in key/encoder/touch maps.
  layer: 3

# Per-layer key map.
# Each key entry fields:
# - gpio: GPIO pin symbol (example: GPIO_NUM_7)
# - active_low: true when button pulls signal low on press
# - led_index: SK6812 LED index (0xFF means no LED)
# - type: MACRO_ACTION_KEYBOARD or MACRO_ACTION_CONSUMER
# - usage: HID usage symbol (example: HID_KEY_A / HID_USAGE_CONSUMER_MUTE)
# - name: label used for debug logs
keymap_layers:
  - name: Layer 1 (default)
    keys:
      - { gpio: GPIO_NUM_7,  active_low: true, led_index: 3,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_A,   name: K1 }
      - { gpio: GPIO_NUM_8,  active_low: true, led_index: 4,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_B,   name: K2 }
      - { gpio: GPIO_NUM_9,  active_low: true, led_index: 5,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_C,   name: K3 }
      - { gpio: GPIO_NUM_17, active_low: true, led_index: 6,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_D,   name: K4 }
      - { gpio: GPIO_NUM_18, active_low: true, led_index: 10, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F17, name: K5 }
      - { gpio: GPIO_NUM_12, active_low: true, led_index: 9,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F18, name: K6 }
      - { gpio: GPIO_NUM_13, active_low: true, led_index: 8,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F19, name: K7 }
      - { gpio: GPIO_NUM_14, active_low: true, led_index: 7,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F20, name: K8 }
      - { gpio: GPIO_NUM_1,  active_low: true, led_index: 11, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F21, name: K9 }
      - { gpio: GPIO_NUM_2,  active_low: true, led_index: 12, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F22, name: K10 }
      - { gpio: GPIO_NUM_40, active_low: true, led_index: 13, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F23, name: K11 }
      - { gpio: GPIO_NUM_41, active_low: true, led_index: 14, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F24, name: K12 }

  - name: Layer 2
    keys:
      - { gpio: GPIO_NUM_7,  active_low: true, led_index: 3,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_1,     name: K1 }
      - { gpio: GPIO_NUM_8,  active_low: true, led_index: 4,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_2,     name: K2 }
      - { gpio: GPIO_NUM_9,  active_low: true, led_index: 5,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_3,     name: K3 }
      - { gpio: GPIO_NUM_17, active_low: true, led_index: 6,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_4,     name: K4 }
      - { gpio: GPIO_NUM_18, active_low: true, led_index: 10, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_5,     name: K5 }
      - { gpio: GPIO_NUM_12, active_low: true, led_index: 9,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_6,     name: K6 }
      - { gpio: GPIO_NUM_13, active_low: true, led_index: 8,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_7,     name: K7 }
      - { gpio: GPIO_NUM_14, active_low: true, led_index: 7,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_8,     name: K8 }
      - { gpio: GPIO_NUM_1,  active_low: true, led_index: 11, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_9,     name: K9 }
      - { gpio: GPIO_NUM_2,  active_low: true, led_index: 12, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_0,     name: K10 }
      - { gpio: GPIO_NUM_40, active_low: true, led_index: 13, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_MINUS, name: K11 }
      - { gpio: GPIO_NUM_41, active_low: true, led_index: 14, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_EQUAL, name: K12 }

  - name: Layer 3
    keys:
      - { gpio: GPIO_NUM_7,  active_low: true, led_index: 3,  type: MACRO_ACTION_CONSUMER, usage: HID_USAGE_CONSUMER_MUTE,                name: K1 }
      - { gpio: GPIO_NUM_8,  active_low: true, led_index: 4,  type: MACRO_ACTION_CONSUMER, usage: HID_USAGE_CONSUMER_VOLUME_DECREMENT,    name: K2 }
      - { gpio: GPIO_NUM_9,  active_low: true, led_index: 5,  type: MACRO_ACTION_CONSUMER, usage: HID_USAGE_CONSUMER_VOLUME_INCREMENT,    name: K3 }
      - { gpio: GPIO_NUM_17, active_low: true, led_index: 6,  type: MACRO_ACTION_CONSUMER, usage: HID_USAGE_CONSUMER_PLAY_PAUSE,          name: K4 }
      - { gpio: GPIO_NUM_18, active_low: true, led_index: 10, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F1,                             name: K5 }
      - { gpio: GPIO_NUM_12, active_low: true, led_index: 9,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F2,                             name: K6 }
      - { gpio: GPIO_NUM_13, active_low: true, led_index: 8,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F3,                             name: K7 }
      - { gpio: GPIO_NUM_14, active_low: true, led_index: 7,  type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F4,                             name: K8 }
      - { gpio: GPIO_NUM_1,  active_low: true, led_index: 11, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F5,                             name: K9 }
      - { gpio: GPIO_NUM_2,  active_low: true, led_index: 12, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F6,                             name: K10 }
      - { gpio: GPIO_NUM_40, active_low: true, led_index: 13, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F7,                             name: K11 }
      - { gpio: GPIO_NUM_41, active_low: true, led_index: 14, type: MACRO_ACTION_KEYBOARD, usage: HID_KEY_F8,                             name: K12 }

# Per-layer base color before dim/active scaling (0..255 each channel).
layer_backlight_colors:
  - { r: 90, g: 90, b: 0 }   # Layer 1 example: yellow
  - { r: 0,  g: 90, b: 0 }   # Layer 2 example: green
  - { r: 0,  g: 0,  b: 90 }  # Layer 3 example: blue

# Global LED brightness groups and layer color scaling.
led:
  # LEDs 0/1/2 (USB mounted, HID ready, layer indicator), 0..255.
  indicator_brightness: 16
  # Key backlight LED group, 0..255.
  key_brightness: 10
  # Idle scale applied to layer_backlight_colors, 0..255.
  layer_key_dim_scale: 45
  # Pressed-key scale applied to layer_backlight_colors, 0..255.
  layer_key_active_scale: 140

# Encoder behavior.
encoder:
  # Encoder button input polarity.
  button_active_low: true
  # Multi-tap collection window in milliseconds.
  tap_window_ms: 350
  # Delay before dispatching single-tap action in milliseconds.
  single_tap_delay_ms: 120
  # Per-layer encoder mappings.
  layers:
    - { button_single_usage: HID_USAGE_CONSUMER_PLAY_PAUSE,       cw_usage: HID_USAGE_CONSUMER_VOLUME_INCREMENT, ccw_usage: HID_USAGE_CONSUMER_VOLUME_DECREMENT }
    - { button_single_usage: HID_USAGE_CONSUMER_SCAN_NEXT_TRACK,  cw_usage: HID_USAGE_CONSUMER_VOLUME_INCREMENT, ccw_usage: HID_USAGE_CONSUMER_VOLUME_DECREMENT }
    - { button_single_usage: HID_USAGE_CONSUMER_PLAY_PAUSE,       cw_usage: HID_USAGE_CONSUMER_SCAN_NEXT_TRACK,  ccw_usage: HID_USAGE_CONSUMER_SCAN_PREVIOUS_TRACK }

# Touch slider behavior.
touch:
  # Per-layer touch mappings.
  # NOTE: left_usage is fired by R->L swipe; right_usage by L->R swipe.
  layers:
    - { left_usage: HID_USAGE_CONSUMER_SCAN_PREVIOUS_TRACK, right_usage: HID_USAGE_CONSUMER_SCAN_NEXT_TRACK,       left_hold_repeat: false, right_hold_repeat: false, hold_start_ms: 0,   hold_repeat_ms: 0 }
    - { left_usage: HID_USAGE_CONSUMER_VOLUME_DECREMENT,    right_usage: HID_USAGE_CONSUMER_VOLUME_INCREMENT,       left_hold_repeat: true,  right_hold_repeat: true,  hold_start_ms: 220, hold_repeat_ms: 110 }
    - { left_usage: HID_USAGE_CONSUMER_BRIGHTNESS_DECREMENT,right_usage: HID_USAGE_CONSUMER_BRIGHTNESS_INCREMENT,   left_hold_repeat: false, right_hold_repeat: false, hold_start_ms: 0,   hold_repeat_ms: 0 }

  # Percent threshold for touch-active detection: baseline * percent / 100.
  trigger_percent: 85
  # Percent threshold for touch-release detection (normally > trigger_percent).
  release_percent: 92
  # Absolute minimum (baseline - raw) to enter active state.
  trigger_min_delta: 3500
  # Absolute minimum (baseline - raw) to remain active.
  release_min_delta: 1800
  # Max time from first-side contact to opposite-side contact to count as swipe.
  gesture_window_ms: 650
  # Minimum interval between emitted gestures.
  min_interval_ms: 280
  # Freeze baseline early when contact is clearly intentional.
  baseline_freeze_total_delta: 1200
  baseline_freeze_side_delta: 600
  # Minimum contact strength checks.
  contact_min_total_delta: 1500
  contact_min_side_delta: 700
  # Minimum |dR-dL| to establish swipe start side.
  start_side_delta: 250
  # Minimum filtered balance travel to trigger swipe.
  gesture_travel_delta: 450
  # Side-visited thresholds used by anti-false-positive logic.
  swipe_side_min_delta: 1500
  swipe_side_relative_percent: 20
  require_both_sides: true
  both_sides_hold_ms: 50
  side_sequence_min_ms: 20
  start_dominant_min_ms: 30
  min_swipe_ms: 100
  # Minimum dominance to confirm direction switch.
  direction_dominance_delta: 650
  # Set true only if physical wiring is mirrored.
  swap_sides: false
  # Verbose tuning logs.
  debug_log_enable: false
  debug_log_interval_ms: 80
  # Idle-noise compensation.
  idle_noise_margin: 120
  idle_noise_max_delta: 2400

# OLED display and burn-in protection.
oled:
  # Normal brightness (0..100%).
  default_brightness_percent: 70
  # Dimmed brightness used after inactivity timeout (0..100%).
  dim_brightness_percent: 15
  # Time to dim when no input is detected.
  dim_timeout_sec: 45
  # Time to fully turn off display when no input is detected.
  off_timeout_sec: 180
  # Random shift radius in pixels (+/- range).
  shift_range_px: 2
  # Interval of random pixel shifts.
  shift_interval_sec: 60
  # OLED I2C speed in Hz.
  i2c_scl_hz: 800000

# Passive buzzer profile.
buzzer:
  # Master enable switch (false compiles out runtime buzzer behavior).
  enabled: true
  # Buzzer pin symbol (example: GPIO_NUM_21).
  gpio: GPIO_NUM_21
  # LEDC duty in percent.
  duty_percent: 28
  # Tone queue depth.
  queue_size: 16
  # Gap inserted between RTTTL notes in milliseconds.
  rtttl_note_gap_ms: 8

  startup:
    enabled: true
    # Example RTTTL melody: Mario intro phrase.
    rtttl: 'mario:d=4,o=5,b=100:16e6,16e6,32p,8e6,16c6,8e6,8g6,8p,8g,8p'

  keypress:
    enabled: true
    # Short click for key down event.
    rtttl: 'key:d=32,o=6,b=180:c'

  layer_switch:
    enabled: true
    # Convention: layer N beeps N times.
    layer1_rtttl: 'l1:d=16,o=6,b=180:g'
    layer2_rtttl: 'l2:d=16,o=6,b=180:g,g'
    layer3_rtttl: 'l3:d=16,o=6,b=180:g,g,g'

  encoder_step:
    enabled: true
    cw_rtttl: 'cw:d=32,o=6,b=220:e'
    ccw_rtttl: 'ccw:d=32,o=6,b=220:d'
    # Throttle fast encoder spam to avoid long audio tail.
    min_interval_ms: 14

  # Optional encoder-button tap shortcut to toggle buzzer runtime on/off.
  # Suggested tap counts:
  # - 5 keeps compatibility with current layer-switch multi-tap behavior (2/3/4 taps).
  encoder_toggle:
    enabled: false
    tap_count: 5
    on_rtttl: 'bon:d=32,o=6,b=180:g'
    off_rtttl: 'boff:d=32,o=5,b=180:e'
